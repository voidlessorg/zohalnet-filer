name: Smart VPN Config Sender (Timed Chunks)

on:
  schedule:
    - cron: "*/30 * * * *"  # Ÿáÿ± ŸÜ€åŸÖ ÿ≥ÿßÿπÿ™
  workflow_dispatch:

jobs:
  send-chunk:
    runs-on: ubuntu-latest

    steps:
      - name: Restore state
        uses: actions/cache@v4
        with:
          path: CONFIG_HASH_CACHE.txt
          key: smart-config-hash

      - name: Download config
        run: |
          curl -fsS "https://raw.githubusercontent.com/MahsaNetConfigTopic/config/refs/heads/main/xray_final.txt" -o config.txt

      - name: Compute hash & prepare chunks
        run: |
          NEW_HASH=$(sha256sum config.txt | awk '{print $1}')
          if [ -f CONFIG_HASH_CACHE.txt ]; then
            OLD_HASH=$(head -1 CONFIG_HASH_CACHE.txt)
            LAST_SENT=$(tail -1 CONFIG_HASH_CACHE.txt | cut -d'/' -f1)
          else
            OLD_HASH=""
            LAST_SENT=0
          fi

          # ÿß⁄Øÿ± ⁄©ÿßŸÜŸÅ€å⁄Ø ÿ™ÿ∫€å€åÿ± ⁄©ÿ±ÿØÿå ÿØŸàÿ®ÿßÿ±Ÿá chunk ÿ®ÿ≥ÿßÿ≤
          if [ "$NEW_HASH" != "$OLD_HASH" ]; then
            rm -f chunk_*
            split -b 3900 config.txt chunk_
            TOTAL=$(ls chunk_* | wc -l)
            echo "$NEW_HASH" > CONFIG_HASH_CACHE.txt
            echo "0/$TOTAL" >> CONFIG_HASH_CACHE.txt
          else
            TOTAL=$(tail -1 CONFIG_HASH_CACHE.txt | cut -d'/' -f2)
          fi

      - name: Send next chunk
        env:
          BOT_TOKEN: ${{ secrets.TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          LAST_SENT=$(tail -1 CONFIG_HASH_CACHE.txt | cut -d'/' -f1)
          TOTAL=$(tail -1 CONFIG_HASH_CACHE.txt | cut -d'/' -f2)
          NEXT=$((LAST_SENT+1))

          if [ "$NEXT" -le "$TOTAL" ]; then
            CHUNK_FILE=$(ls chunk_* | sed -n "${NEXT}p")
            HEADER="<b>üì¶ VPN Config Update</b>\nüïí $(date '+%H:%M %d-%b')\nChunk ${NEXT}/${TOTAL}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            MESSAGE="${HEADER}<pre>$(cat $CHUNK_FILE)</pre>"

            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              --data-urlencode "chat_id=${CHAT_ID}" \
              --data-urlencode "text=${MESSAGE}" \
              --data-urlencode "parse_mode=HTML"

            # Update last sent
            sed -i "\$d" CONFIG_HASH_CACHE.txt
            echo "${NEXT}/${TOTAL}" >> CONFIG_HASH_CACHE.txt
          fi

      - name: Save hash state
        uses: actions/cache@v4
        with:
          path: CONFIG_HASH_CACHE.txt
          key: smart-config-hash

name: Send Xray/VPN Configs Smart

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # ูุฑ ฑ ุณุงุนุช

jobs:
  send-config:
    runs-on: ubuntu-latest

    steps:
      - name: Restore last hash
        uses: actions/cache@v4
        with:
          path: last_hash2.txt
          key: smart-config-hash

      - name: Download config
        run: |
          export TZ=Asia/Tehran
          curl -fsS "https://raw.githubusercontent.com/MahsaNetConfigTopic/config/refs/heads/main/xray_final.txt" -o config.txt

      - name: Compute hash & compare
        run: |
          NEW_HASH=$(sha256sum config.txt | awk '{print $1}')
          OLD_HASH=""
          if [ -f last_hash2.txt ]; then
            OLD_HASH=$(cat last_hash.txt)
          fi

          if [ "$NEW_HASH" = "$OLD_HASH" ]; then
            echo "NO_CHANGE=true" >> $GITHUB_ENV
          else
            echo "$NEW_HASH" > last_hash.txt
            echo "NO_CHANGE=false" >> $GITHUB_ENV
          fi

      - name: Build filename with Gregorian month
        if: env.NO_CHANGE == 'false'
        run: |
          export TZ=Asia/Tehran
          HOUR=$(date '+%H')
          DAY=$(date '+%d')
          MONTH_NUM=$(date '+%m')
          case "$MONTH_NUM" in
            01) MONTH="Jan" ;;
            02) MONTH="Feb" ;;
            03) MONTH="Mar" ;;
            04) MONTH="Apr" ;;
            05) MONTH="May" ;;
            06) MONTH="Jun" ;;
            07) MONTH="Jul" ;;
            08) MONTH="Aug" ;;
            09) MONTH="Sep" ;;
            10) MONTH="Oct" ;;
            11) MONTH="Nov" ;;
            12) MONTH="Dec" ;;
          esac
          FILENAME="${HOUR}:00 - ${DAY} - ${MONTH} - smart-config.txt"
          mv config.txt "$FILENAME"
          echo "FILENAME=$FILENAME" >> $GITHUB_ENV

      - name: Send config in chunks to Telegram
        if: env.NO_CHANGE == 'false'
        env:
          BOT_TOKEN: ${{ secrets.TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          #!/bin/bash
          FILE="$FILENAME"
          MAX_CHARS=3500  # ฺฉูุชุฑ ุงุฒ 4096 ุจุฑุง ุณุฑุจุฑฺฏ ู ฺฉุฏ ุจูุงฺฉ
          LINE_NUM=0

          # ฺฉู ูุญุชูุง
          CONTENT=$(cat "$FILE")

          # ุชุงุจุน ุจุฑุง ุงุฑุณุงู ฺฉ ูพุงู
          send_chunk() {
            CHUNK="$1"
            HOUR=$(date '+%H')
            DAY=$(date '+%d')
            MONTH_NUM=$(date '+%m')
            case "$MONTH_NUM" in
              01) MONTH="Jan" ;;
              02) MONTH="Feb" ;;
              03) MONTH="Mar" ;;
              04) MONTH="Apr" ;;
              05) MONTH="May" ;;
              06) MONTH="Jun" ;;
              07) MONTH="Jul" ;;
              08) MONTH="Aug" ;;
              09) MONTH="Sep" ;;
              10) MONTH="Oct" ;;
              11) MONTH="Nov" ;;
              12) MONTH="Dec" ;;
            esac
            HEADER="๐ฆ *VPN Config Update*\n๐ ${HOUR}:00 ${DAY}-${MONTH}\nโโโโโโโโโโโโโ"
            MESSAGE="${HEADER}\n\`\`\`\n${CHUNK}\n\`\`\`"
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
                 -d chat_id="${CHAT_ID}" \
                 -d text="$MESSAGE" \
                 -d parse_mode="Markdown"
          }

          # ุจุฎุดโุจูุฏ ูุญุชูุง ุจุฏูู ูุตู ุดุฏู ฺฉุงููฺฏ
          BUFFER=""
          while IFS= read -r line; do
            # ุงฺฏุฑ ุงูุฏุงุฒู ุจุง ุฎุท ุฌุฏุฏ ุจุดุชุฑ ุงุฒ MAX_CHARS ุดุฏ โ ุงุฑุณุงู ฺฉู
            if [ ${#BUFFER} -gt $MAX_CHARS ]; then
              send_chunk "$BUFFER"
              BUFFER=""
            fi
            BUFFER+="$line"$'\n'
          done <<< "$CONTENT"

          # ุงุฑุณุงู ุจุงูโูุงูุฏู
          if [ ! -z "$BUFFER" ]; then
            send_chunk "$BUFFER"
          fi

      - name: Save hash
        if: env.NO_CHANGE == 'false'
        uses: actions/cache@v4
        with:
          path: last_hash.txt
          key: smart-config-hash

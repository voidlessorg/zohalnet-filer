name: Fetch Xray Config

# اجرای دستی و زمان‌بندی ۳۰ دقیقه
on:
  workflow_dispatch:   # برای اجرای دستی
  schedule:
    - cron: "*/30 * * * *"  # هر ۳۰ دقیقه

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      # مرحله ۱: دانلود کانفیگ از لینک Raw
      - name: Download Xray Config
        run: |
          curl -s "https://raw.githubusercontent.com/MahsaNetConfigTopic/config/refs/heads/main/xray_final.txt" -o config.txt

      # مرحله ۲: ارسال به تلگرام به صورت فایل با دلیل و زمان بعدی
      - name: Send Config to Telegram with Reason and Next Update
        run: |
          # تشخیص نوع ران
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REASON="Manual Run"
          else
            REASON="Scheduled Run"
          fi

          # زمان بروزرسانی بعدی
          NEXT_RUN=$(date -d "+30 min" '+%Y-%m-%d %H:%M')

          # ارسال فایل به تلگرام
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN }}/sendDocument" \
            -F chat_id="${{ secrets.CHAT_ID }}" \
            -F document=@config.txt \
            -F caption="Xray Config Update
Mode: $REASON
Next Update: $NEXT_RUN"

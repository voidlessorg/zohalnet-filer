name: Smart VPN Config Sender

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # Ÿáÿ± €± ÿ≥ÿßÿπÿ™

jobs:
  send-config:
    runs-on: ubuntu-latest

    steps:
      - name: Restore last hash
        uses: actions/cache@v4
        with:
          path: CONFIG_HASH_CACHE.txt
          key: smart-config-hash

      - name: Download config
        run: |
          curl -fsS "https://raw.githubusercontent.com/MahsaNetConfigTopic/config/refs/heads/main/xray_final.txt" -o config.txt

      - name: Compute hash & compare
        run: |
          NEW_HASH=$(sha256sum config.txt | awk '{print $1}')
          OLD_HASH=""
          if [ -f CONFIG_HASH_CACHE.txt ]; then
            OLD_HASH=$(cat CONFIG_HASH_CACHE.txt)
          fi

          if [ "$NEW_HASH" = "$OLD_HASH" ]; then
            echo "NO_CHANGE=true" >> $GITHUB_ENV
          else
            echo "$NEW_HASH" > CONFIG_HASH_CACHE.txt
            echo "NO_CHANGE=false" >> $GITHUB_ENV
          fi

      - name: Build filename with Gregorian month
        if: env.NO_CHANGE == 'false'
        run: |
          HOUR=$(date '+%H')
          DAY=$(date '+%d')
          MONTH_NUM=$(date '+%m')
          case "$MONTH_NUM" in
            01) MONTH="Jan" ;;
            02) MONTH="Feb" ;;
            03) MONTH="Mar" ;;
            04) MONTH="Apr" ;;
            05) MONTH="May" ;;
            06) MONTH="Jun" ;;
            07) MONTH="Jul" ;;
            08) MONTH="Aug" ;;
            09) MONTH="Sep" ;;
            10) MONTH="Oct" ;;
            11) MONTH="Nov" ;;
            12) MONTH="Dec" ;;
          esac
          FILENAME="${HOUR}:00 - ${DAY} - ${MONTH} - smart-config.txt"
          mv config.txt "$FILENAME"
          echo "FILENAME=$FILENAME" >> $GITHUB_ENV

      - name: Send config in chunks securely
        if: env.NO_CHANGE == 'false'
        env:
          Bot_token: ${{ secrets.TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          #!/bin/bash
          MAX_CHARS=3500
          FILE="$FILENAME"
          CONTENT=$(cat "$FILE")
          BUFFER=""

          send_chunk() {
            CHUNK="$1"
            HEADER="üì¶ *VPN Config Update*\nüïí $(date '+%H:%M %d-%b')\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            MESSAGE="${HEADER}\n\`\`\`\n${CHUNK}\n\`\`\`"

            curl -s -X POST "https://api.telegram.org/bot${Bot_token}/sendMessage" \
                 -d chat_id="${CHAT_ID}" \
                 -d text="$MESSAGE" \
                 -d parse_mode="MarkdownV2"
          }

          while IFS= read -r line; do
            if [ $(( ${#BUFFER} + ${#line} + 1 )) -gt $MAX_CHARS ]; then
              send_chunk "$BUFFER"
              BUFFER=""
            fi
            BUFFER+="$line"$'\n'
          done <<< "$CONTENT"

          if [ ! -z "$BUFFER" ]; then
            send_chunk "$BUFFER"
          fi

      - name: Save hash
        if: env.NO_CHANGE == 'false'
        uses: actions/cache@v4
        with:
          path: CONFIG_HASH_CACHE.txt
          key: smart-config-hash

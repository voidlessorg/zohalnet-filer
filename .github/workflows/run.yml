name: Fetch Xray Config

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Download Xray Config
        run: |
          curl -s "https://raw.githubusercontent.com/MahsaNetConfigTopic/config/refs/heads/main/xray_final.txt" -o config.txt

      - name: Send Config to Telegram
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REASON="Manual Run"
          else
            REASON="Scheduled Run"
          fi

          NEXT_RUN=$(date -d "+30 min" '+%Y-%m-%d %H:%M')

          # ارسال فایل با Caption multi-line درست
          CAPTION="Xray Config Update\nMode: $REASON\nNext Update: $NEXT_RUN"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TOKEN }}/sendDocument" \
            -F chat_id="${{ secrets.CHAT_ID }}" \
            -F document=@config.txt \
            -F caption="$CAPTION"

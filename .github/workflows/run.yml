name: Smart VPN Config Sender (HTML Mode fixed)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # Ù‡Ø± Û± Ø³Ø§Ø¹Øª

jobs:
  send-config:
    runs-on: ubuntu-latest

    steps:
      - name: Restore last hash
        uses: actions/cache@v4
        with:
          path: CONFIG_HASSH_CACHE.txt
          key: smart-config-hash

      - name: Download config
        run: |
          curl -fsS "https://raw.githubusercontent.com/MahsaNetConfigTopic/config/refs/heads/main/xray_final.txt" -o config.txt

      - name: Compute hash & compare
        run: |
          NEW_HASH=$(sha256sum config.txt | awk '{print $1}')
          OLD_HASH=""
          if [ -f CONFIG_HASSH_CACHE.txt ]; then
            OLD_HASH=$(cat CONFIG_HASH_CACHE.txt)
          fi

          if [ "$NEW_HASH" = "$OLD_HASH" ]; then
            echo "NO_CHANGE=true" >> $GITHUB_ENV
          else
            echo "$NEW_HASH" > CONFIG_HASH_CACHE.txt
            echo "NO_CHANGE=false" >> $GITHUB_ENV
          fi

      - name: Build filename with Gregorian month
        if: env.NO_CHANGE == 'false'
        run: |
          HOUR=$(date '+%H')
          DAY=$(date '+%d')
          MONTH_NUM=$(date '+%m')
          case "$MONTH_NUM" in
            01) MONTH="Jan" ;;
            02) MONTH="Feb" ;;
            03) MONTH="Mar" ;;
            04) MONTH="Apr" ;;
            05) MONTH="May" ;;
            06) MONTH="Jun" ;;
            07) MONTH="Jul" ;;
            08) MONTH="Aug" ;;
            09) MONTH="Sep" ;;
            10) MONTH="Oct" ;;
            11) MONTH="Nov" ;;
            12) MONTH="Dec" ;;
          esac
          FILENAME="${HOUR}:00 - ${DAY} - ${MONTH} - smart-config.txt"
          mv config.txt "$FILENAME"
          echo "FILENAME=$FILENAME" >> $GITHUB_ENV

      - name: Send config in chunks (HTML safe)
        if: env.NO_CHANGE == 'false'
        env:
          BOT_TOKEN: ${{ secrets.TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          #!/bin/bash
          set -euo pipefail

          MAX_CHARS=3800
          FILE="$FILENAME"
          CONTENT=$(cat "$FILE")
          BUFFER=""

          send_chunk() {
            CHUNK="$1"
            # header: Ø§Ø² <br> Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒØ´Ù‡ØŒ Ø§Ø² \n Ø¨Ø±Ø§ÛŒ Ø®Ø· Ø¬Ø¯ÛŒØ¯
            HEADER="<b>ğŸ“¦ VPN Config Update</b>\nğŸ•’ $(date '+%H:%M %d-%b')\nâ”â”â”â”â”â”â”â”â”â”â”â”â”"
            # Ú©Ø§Ù†ÙÛŒÚ¯ Ø¯Ø§Ø®Ù„ pre ØªØ§ ØªÙ„Ú¯Ø±Ø§Ù… Ù…ØªÙ† Ø±Ùˆ Ø®Ø§Ù… Ø¨Ú¯ÛŒØ±Ù‡
            MESSAGE="${HEADER}<pre>${CHUNK}</pre>"

            # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² --data-urlencode Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù† Ø¨ÙˆØ¯Ù† Ù…ØªÙ†
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              --data-urlencode "chat_id=${CHAT_ID}" \
              --data-urlencode "text=${MESSAGE}" \
              --data-urlencode "parse_mode=HTML"
          }

          # Ø¨Ø®Ø´â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ø­ØªÙˆØ§ Ø®Ø· Ø¨Ù‡ Ø®Ø· Ø¨Ù‡ Ø·ÙˆØ±ÛŒ Ú©Ù‡ Ú©Ø§Ù†ÙÛŒÚ¯ Ù‡Ø§ Ù†ØµÙ Ù†Ø´Ù†
          while IFS= read -r line || [ -n "$line" ]; do
            # Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø§ÛŒÙ† Ø®Ø· Ú†Ú© Ù…ÛŒØ´Ù‡
            NEW_LEN=$(( ${#BUFFER} + ${#line} + 1 ))
            if [ "$NEW_LEN" -gt "$MAX_CHARS" ]; then
              # Ø§Ø±Ø³Ø§Ù„ buffer ÙØ¹Ù„ÛŒ
              send_chunk "$BUFFER"
              BUFFER=""
            fi
            BUFFER+="$line"$'\n'
          done <<< "$CONTENT"

          # Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡
          if [ -n "$BUFFER" ]; then
            send_chunk "$BUFFER"
          fi

      - name: Save hash
        if: env.NO_CHANGE == 'false'
        uses: actions/cache@v4
        with:
          path: CONFIG_HASH_CACHE.txt
          key: smart-config-hash

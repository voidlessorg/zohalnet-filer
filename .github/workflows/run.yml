name: Xray Config (Send Only On Change)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # Ù‡Ø± Û± Ø³Ø§Ø¹Øª

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Restore last hash
        uses: actions/cache@v4
        with:
          path: last_hash.txt
          key: xray-config-hash

      - name: Download config & compare
        run: |
          set -e
          export TZ=Asia/Tehran

          curl -fsS "https://raw.githubusercontent.com/MahsaNetConfigTopic/config/refs/heads/main/xray_final.txt" -o new_config.txt

          NEW_HASH=$(sha256sum new_config.txt | awk '{print $1}')
          OLD_HASH=""
          if [ -f last_hash.txt ]; then
            OLD_HASH=$(cat last_hash.txt)
          fi

          if [ "$NEW_HASH" = "$OLD_HASH" ]; then
            echo "NO_CHANGE=true" >> $GITHUB_ENV
          else
            echo "$NEW_HASH" > last_hash.txt
            echo "NO_CHANGE=false" >> $GITHUB_ENV
          fi

      - name: Build filename
        if: env.NO_CHANGE == 'false'
        run: |
          export TZ=Asia/Tehran

          HOUR=$(date '+%H')
          DAY=$(date '+%d')
          MONTH_NUM=$(date '+%m')

          case "$MONTH_NUM" in
            01) MONTH="Jan" ;;
            02) MONTH="Feb" ;;
            03) MONTH="Mar" ;;
            04) MONTH="April" ;;
            05) MONTH="May" ;;
            06) MONTH="June" ;;
            07) MONTH="Jul" ;;
            08) MONTH="Aug" ;;
            09) MONTH="Sep" ;;
            10) MONTH="Oct" ;;
            11) MONTH="Nov" ;;
            12) MONTH="Dec" ;;
          esac

          CONFIG_NAME="MAHSANET"
          FILENAME="${HOUR}:00 - ${DAY} - ${MONTH} - ${CONFIG_NAME}"

          mv new_config.txt "$FILENAME"
          echo "FILENAME=$FILENAME" >> $GITHUB_ENV

      - name: Send to Telegram
        if: env.NO_CHANGE == 'false'
        env:
          BOT_TOKEN: ${{ secrets.TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          export TZ=Asia/Tehran
          NOW=$(date '+%Y-%m-%d %H:%M')

          CAPTION=$(printf "ðŸ“¦ *Xray Config Updated*\nðŸ•’ %s IR" "$NOW")

          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F chat_id="${CHAT_ID}" \
            -F document=@"$FILENAME" \
            -F caption="$CAPTION" \
            -F parse_mode=Markdown

      - name: Save hash
        if: env.NO_CHANGE == 'false'
        uses: actions/cache@v4
        with:
          path: last_hash.txt
          key: xray-config-hash
